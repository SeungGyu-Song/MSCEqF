// Copyright (C) 2023 Alessandro Fornasier.
// Control of Networked Systems, University of Klagenfurt, Austria.
//
// All rights reserved.
//
// This software is licensed under the terms of the BSD-2-Clause-License with
// no commercial use allowed, the full terms of which are made available
// in the LICENSE file. No license in patents is granted.
//
// You can contact the authors at <alessandro.fornasier@ieee.org>

#ifndef TEST_MSCEQF_HPP
#define TEST_MSCEQF_HPP

#include "msceqf/msceqf.hpp"

namespace msceqf
{

class MSCEqFPropagationImuMeasurementSelectionTest : public ::testing::TestWithParam<fp>
{
 public:
  void triggerPropagationAt(const fp& t)
  {
    MSCEqF sys(filepath_base + "parameters.yaml");

    for (int i = 0; i < 100; ++i)
    {
      Imu imu;
      imu.timestamp_ = i * 0.1;
      sys.processMeasurement(imu);
    }

    Camera cam;
    cam.timestamp_ = t;
    sys.processMeasurement(cam);
  }

 protected:
  std::string filepath_base = "/home/alfornasier/PhD/MSCEqF_dev/MSCEqF/config/";
};

TEST_P(MSCEqFPropagationImuMeasurementSelectionTest, ImuMeasurementSelection)
{
  fp timestamp = GetParam();
  triggerPropagationAt(timestamp);
}

TEST(MSCEqFTest, Construction)
{
  std::string filepath_base = "/home/alfornasier/PhD/MSCEqF_dev/MSCEqF/config/";
  MSCEqF sys(filepath_base + "parameters.yaml");
}

// TEST(MSCEqFMeanPropagationTest, meanPropagation)
// {
//   std::string filepath_base = "/home/alfornasier/PhD/MSCEqF_dev/MSCEqF/config/";
//   MSCEqF sys(filepath_base + "parameters.yaml");
// }

// Camera timestamp in between Imu timestamps
// Camera timestamp equal to a Imu timestamp in the middle
// Camera timestamp equal to the last Imu timestamp
// Camera timestamp grater than the last Imu timestamp
// Camera timestamp grater than the first Imu timestamp but smaller than the second
// Camera timestamp equal to the first Imu timestamp
INSTANTIATE_TEST_CASE_P(ImuMeasurementSelectionTest,
                        MSCEqFPropagationImuMeasurementSelectionTest,
                        ::testing::Values(7.05, 5.0, 9.9, 11, 0.05, 0.0));

TEST(MSCEqFPropagationTest, CovariancePropagation)
{
  std::string filepath_base = "/home/alfornasier/PhD/MSCEqF_dev/MSCEqF/config/";
  MSCEqF sys(filepath_base + "parameters.yaml");

  Imu imu0, imu1;
  imu0.timestamp_ = 100;
  imu0.ang_ = Vector3(-2.0610369, 0.50198013, 1.31285766);
  imu0.acc_ = Vector3(1.05816941, -0.01242794, 9.01057572);
  imu1.timestamp_ = 100.01;

  sys.processMeasurement(imu0);
  sys.processMeasurement(imu1);

  Camera cam;
  cam.timestamp_ = 100.01;
  sys.processMeasurement(cam);

  Eigen::Matrix<fp, 25, 25> ExpectedCov;
  ExpectedCov << 1.00010001e-02, -8.62148424e-16, -2.25482662e-15, -9.89468309e-15, -9.81000005e-04, 7.80196938e-15,
      -5.38213951e-17, -4.90500002e-06, 2.17882996e-17, 9.99967075e-09, 6.54670508e-11, -2.55486655e-11, 5.28518243e-13,
      -7.99214908e-11, 2.06602267e-12, -7.27920456e-05, 5.75078652e-05, 1.05602593e-04, 3.02878477e-05, -6.22100292e-05,
      6.08283645e-05, 0.0, 0.0, 0.0, 0.0, -8.62148424e-16, 1.00010001e-02, 5.49178990e-16, 9.81000005e-04,
      -7.99794016e-15, 5.28402064e-13, 4.90500002e-06, -5.35048617e-17, 1.76194061e-15, -6.58119066e-11, 9.99900479e-09,
      -1.02936666e-10, 8.02001563e-11, 1.61503638e-12, 1.05605046e-10, 1.60659711e-04, 7.22622446e-05, 1.69367009e-04,
      6.88733145e-05, 6.64130497e-05, -8.98515939e-05, 0.0, 0.0, 0.0, 0.0, -2.25482662e-15, 5.49178990e-16,
      1.00010100e-06, -2.20926870e-14, -5.24535938e-13, 1.82255905e-15, -1.05934625e-16, -1.74101336e-15,
      4.59589672e-21, 2.46467442e-11, 1.03156335e-10, 9.99925005e-09, -5.47219923e-13, -1.05814335e-10, 1.09297259e-12,
      4.98421635e-07, 7.59603375e-07, 4.18065294e-07, -1.92233596e-07, 2.34185857e-07, -1.96320970e-07, 0.0, 0.0, 0.0,
      0.0, -9.89468309e-15, 9.81000005e-04, -2.20926870e-14, 9.72362013e-05, -6.47920289e-16, 2.57787711e-14,
      4.81181011e-07, -1.09902516e-15, 5.00504225e-16, -4.48208061e-12, 5.30475459e-10, -7.67098754e-12, 1.00039259e-08,
      6.55840189e-11, -1.99461556e-11, 1.56862046e-05, 7.10364372e-06, 1.66769978e-05, 6.78820770e-06, 6.45862039e-06,
      -8.76296715e-06, 0.0, 0.0, 0.0, 0.0, -9.81000005e-04, -7.99794016e-15, -5.24535938e-13, -6.47920289e-16,
      9.72362013e-05, 8.32235786e-17, 1.09168105e-15, 4.81181011e-07, 1.71890779e-15, -5.30617541e-10, -4.81837431e-12,
      -5.10999220e-11, -6.58435230e-11, 1.00037998e-08, -1.03060497e-10, 7.18190939e-06, -5.70361619e-06,
      -1.02956851e-05, -2.89109425e-06, 6.11697907e-06, -6.00490513e-06, 0.0, 0.0, 0.0, 0.0, 7.80196938e-15,
      5.28402064e-13, 1.82255905e-15, 2.57787711e-14, 8.32235786e-17, 1.00010100e-06, -3.36134893e-16, -1.71640856e-15,
      5.09990563e-13, 4.33323504e-13, 5.28445708e-11, -3.63964618e-13, 2.50705759e-11, 1.03156705e-10, 9.99980828e-09,
      4.05505573e-13, -8.28241948e-14, -3.28600542e-13, 8.78138055e-14, 6.93688677e-13, -6.65401522e-14, 0.0, 0.0, 0.0,
      0.0, -5.38213951e-17, 4.90500002e-06, -1.05934625e-16, 4.81181011e-07, 1.09168105e-15, -3.36134893e-16,
      2.40690510e-09, -1.24936540e-20, 2.73996437e-19, -1.70316247e-14, 1.76812032e-12, -2.87929257e-14, 5.00117138e-11,
      4.36739488e-13, -1.52025130e-13, 7.84310161e-08, 3.55182199e-08, 8.33849946e-08, 3.39410341e-08, 3.22931027e-08,
      -4.38148206e-08, 0.0, 0.0, 0.0, 0.0, -4.90500002e-06, -5.35048617e-17, -1.74101336e-15, -1.09902516e-15,
      4.81181011e-07, -1.71640856e-15, -1.24936540e-20, 2.40690510e-09, 4.35451859e-21, -1.76878173e-12,
      -1.87384481e-14, -1.69561282e-13, -4.39012154e-13, 5.00085115e-11, -6.86586844e-13, 3.59095511e-08,
      -2.85180859e-08, -5.14784194e-08, -1.44554481e-08, 3.05849041e-08, -3.00245122e-08, 0.0, 0.0, 0.0, 0.0,
      2.17882996e-17, 1.76194061e-15, 4.59589672e-21, 5.00504225e-16, 1.71890779e-15, 5.09990563e-13, 2.73996437e-19,
      4.35451859e-21, 1.00259997e-12, 1.02068751e-15, 1.76199582e-13, -1.81980286e-15, 1.65347368e-13, 6.87804338e-13,
      4.99962366e-11, 1.34735251e-15, -2.78111602e-16, -1.10100163e-15, -1.68633376e-14, 9.35116398e-15, 1.01302256e-14,
      0.0, 0.0, 0.0, 0.0, 9.99967075e-09, -6.58119066e-11, 2.46467442e-11, -4.48208061e-12, -5.30617541e-10,
      4.33323504e-13, -1.70316247e-14, -1.76878173e-12, 1.02068751e-15, 1.01000000e-06, 9.54352164e-25, 3.54240551e-26,
      -1.19427476e-26, -8.01939880e-09, 1.37457480e-10, 4.14239451e-09, -6.30059383e-09, 6.56821428e-09, 8.18409105e-09,
      1.41302803e-09, -3.80603784e-09, 0.0, 0.0, 0.0, 0.0, 6.54670508e-11, 9.99900479e-09, 1.03156335e-10,
      5.30475459e-10, -4.81837431e-12, 5.28445708e-11, 1.76812032e-12, -1.87384481e-14, 1.76199582e-13, -1.05688243e-24,
      1.01000000e-06, -2.71637347e-26, 8.01939880e-09, 4.46042146e-26, 1.05624604e-08, 7.67329525e-09, -1.46312645e-09,
      -6.24298205e-09, -3.20006310e-09, 5.79116828e-09, -5.29045043e-09, 0.0, 0.0, 0.0, 0.0, -2.55486655e-11,
      -1.02936666e-10, 9.99925005e-09, -7.67098754e-12, -5.10999220e-11, -3.63964618e-13, -2.87929257e-14,
      -1.69561282e-13, -1.81980286e-15, 6.61875398e-25, 1.40598261e-24, 1.01000000e-06, -1.37457480e-10,
      -1.05624604e-08, 6.26322128e-26, 4.89448126e-09, 7.62631777e-09, 4.22842532e-09, -1.90971396e-09, 2.27851726e-09,
      -1.89896637e-09, 0.0, 0.0, 0.0, 0.0, 5.28518243e-13, 8.02001563e-11, -5.47219923e-13, 1.00039259e-08,
      -6.58435230e-11, 2.50705759e-11, 5.00117138e-11, -4.39012154e-13, 1.65347368e-13, -1.31752668e-26, 8.01939880e-09,
      -1.37457480e-10, 1.01006433e-06, 1.45188919e-12, 8.47045822e-11, 6.08624316e-11, -1.27816890e-11, -5.06461914e-11,
      -4.75158092e-12, 1.46734295e-11, -9.23814300e-12, 0.0, 0.0, 0.0, 0.0, -7.99214908e-11, 1.61503638e-12,
      -1.05814335e-10, 6.55840189e-11, 1.00037998e-08, 1.03156705e-10, 4.36739488e-13, 5.00085115e-11, 6.87804338e-13,
      -8.01939880e-09, 1.61496735e-28, -1.05624604e-08, 1.45188919e-12, 1.01017588e-06, -1.10232635e-12,
      -8.49172780e-11, -3.00257048e-11, -9.73357046e-11, -6.96435028e-12, -4.26519623e-11, 1.95094674e-11, 0.0, 0.0,
      0.0, 0.0, 2.06602267e-12, 1.05605046e-10, 1.09297259e-12, -1.99461556e-11, -1.03060497e-10, 9.99980828e-09,
      -1.52025130e-13, -6.86586844e-13, 4.99962366e-11, 1.37457480e-10, 1.05624604e-08, 4.75569345e-26, 8.47045822e-11,
      -1.10232635e-12, 1.01011158e-06, 8.16182803e-11, -1.63202790e-11, -6.50384004e-11, -8.35229001e-12,
      9.95462923e-11, -3.51814649e-11, 0.0, 0.0, 0.0, 0.0, -7.27920456e-05, 1.60659711e-04, 4.98421635e-07,
      1.56862046e-05, 7.18190939e-06, 4.05505573e-13, 7.84310161e-08, 3.59095511e-08, 1.34735251e-15, 4.14239451e-09,
      7.67329525e-09, 4.89448126e-09, 6.08624316e-11, -8.49172780e-11, 8.16182803e-11, 1.00004093e-01, 7.32223173e-07,
      1.94995545e-06, 8.90701665e-07, 2.95429696e-04, -3.12646734e-04, 0.0, 0.0, 0.0, 0.0, 5.75078652e-05,
      7.22622446e-05, 7.59603375e-07, 7.10364372e-06, -5.70361619e-06, -8.28241948e-14, 3.55182199e-08, -2.85180859e-08,
      -2.78111602e-16, -6.30059383e-09, -1.46312645e-09, 7.62631777e-09, -1.27816890e-11, -3.00257048e-11,
      -1.63202790e-11, 7.32223173e-07, 1.00001862e-01, 1.84120235e-06, -2.93248046e-04, 1.14206619e-07, -2.09366468e-03,
      0.0, 0.0, 0.0, 0.0, 1.05602593e-04, 1.69367009e-04, 4.18065294e-07, 1.66769978e-05, -1.02956851e-05,
      -3.28600542e-13, 8.33849946e-08, -5.14784194e-08, -1.10100163e-15, 6.56821428e-09, -6.24298205e-09,
      4.22842532e-09, -5.06461914e-11, -9.73357046e-11, -6.50384004e-11, 1.94995545e-06, 1.84120235e-06, 1.00004992e-01,
      3.12255907e-04, 2.09383855e-03, -8.76130306e-07, 0.0, 0.0, 0.0, 0.0, 3.02878477e-05, 6.88733145e-05,
      -1.92233596e-07, 6.78820770e-06, -2.89109425e-06, 8.78138055e-14, 3.39410341e-08, -1.44554481e-08,
      -1.68633376e-14, 8.18409105e-09, -3.20006310e-09, -1.90971396e-09, -4.75158092e-12, -6.96435028e-12,
      -8.35229001e-12, 8.90701665e-07, -2.93248046e-04, 3.12255907e-04, 1.00003197e-01, 6.65089549e-06, 5.59677892e-06,
      0.0, 0.0, 0.0, 0.0, -6.22100292e-05, 6.64130497e-05, 2.34185857e-07, 6.45862039e-06, 6.11697907e-06,
      6.93688677e-13, 3.22931027e-08, 3.05849041e-08, 9.35116398e-15, 1.41302803e-09, 5.79116828e-09, 2.27851726e-09,
      1.46734295e-11, -4.26519623e-11, 9.95462923e-11, 2.95429696e-04, 1.14206619e-07, 2.09383855e-03, 6.65089549e-06,
      1.00045919e-01, -2.28298765e-06, 0.0, 0.0, 0.0, 0.0, 6.08283645e-05, -8.98515939e-05, -1.96320970e-07,
      -8.76296715e-06, -6.00490513e-06, -6.65401522e-14, -4.38148206e-08, -3.00245122e-08, 1.01302256e-14,
      -3.80603784e-09, -5.29045043e-09, -1.89896637e-09, -9.23814300e-12, 1.95094674e-11, -3.51814649e-11,
      -3.12646734e-04, -2.09366468e-03, -8.76130306e-07, 5.59677892e-06, -2.28298765e-06, 1.00046425e-01, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0;

  if (sys.options().state_transition_order_ == 1)
  {
    MatrixEquality(sys.Covariance(), ExpectedCov, 1e-3);
  }
  else
  {
    MatrixEquality(sys.Covariance(), ExpectedCov);
  }
}

}  // namespace msceqf

#endif  // TEST_MSCEQF_HPP